# 实现场景

> 分析的例子来源于：https://www.zhihu.com/question/23486749 作者：无邪气

存在有这样一个场景：当在一个数据中心中，有数个闲置的下载线程，数据中心来任务时，所有闲置的下载线程就会被启动，显示出下载线程的id以及数据中心传入的数据源地址。这个数据中心就是一个被观察对象（发布者），那些等待数据的下载线程就是观察者（订阅者）

# 用观察者模式实现

## UML类图

![](http://markdown.img.esunr.xyz/观察者模式.png)

## 具体实现

实现思路如下：定义一个 DownloadTask 类作为观察者，再定义一个 DownloadTaskList 类放便管理多个下载任务，定义一个 DataHub 作为被观察目标。可以看出观察者与被观察对象是几个完全独立的个体，DownloadTaskList主要负责提供一个任务队列和一些附加的管理方法，方便管理观察者。

在程序创建了一个任务中心后，在去分别创建多个下载线程，使用 `dataHub.addDownloadTask()` 来将线程添加到线程列表中，那么接下来当任务中心使用 `dataHub.notify()` 方法传入数据链接后，下载线程就会得到数据链接并实施具体的方法。

其实现原理就是在 `dataHub` 的 `notify()` 方法中，去遍历数据中心中的任务队列（观察者队列）中的所有任务（观察者），在这些任务实例（观察者）上调用其 `finish()` 方法，并传入参数 `url`。

> 客户端不会去主动调用下载线程（观察者）的 `finish()` 方法，而是交给数据中心（被观察对象）去调用。

```js
// 定义一个 DownloadTask 类作为观察者
function DownloadTask(id) {
  this.id = id;
  this.loaded = false;
  this.url = null;
}

DownloadTask.prototype.finish = function(url) {
  this.loaded = true;
  this.url = url;
  console.log('Task ' + this.id + ' load data from ' + url);
}

// 再定义一个 DownloadTaskList 类放便管理多个下载任务

function DownloadTaskList() {
  this.downloadTaskList = [];
}

DownloadTaskList.prototype.getCount = function() {
  return this.downloadTaskList.length;
};

DownloadTaskList.prototype.get = function(index) {
  return this.downloadTaskList[index];
};

DownloadTaskList.prototype.add = function(obj) {
  return this.downloadTaskList.push(obj);
};

DownloadTaskList.prototype.remove = function(obj) {
  const downloadTaskCount = this.downloadTasks.getCount();
  while (i < downloadTaskCount) {
    if (this.downloadTaskList[i] === obj) {
      this.downloadTaskList.splice(i, 1);
      break;
    }
    i++;
  }
};

// 定义一个 DataHub 作为被观察目标
function DataHub() {
  this.downloadTasks = new DownloadTaskList();
}

DataHub.prototype.addDownloadTask = function(downloadTask) {
  this.downloadTasks.add(downloadTask);
};

DataHub.prototype.removeDownloadTask = function(downloadTask) {
  this.downloadTasks.remove(downloadTask);
};

DataHub.prototype.notify = function(url) {
  const downloadTaskCount = this.downloadTasks.getCount();
  for (var i = 0; i < downloadTaskCount; i++) {
    this.downloadTasks.get(i).finish(url);
  }
};


// 创建一个数据中心
var dataHub = new DataHub();

// 现在用户来取数据了，创建两个任务
var downloadTask1 = new DownloadTask(1);
var downloadTask2 = new DownloadTask(2);
dataHub.addDownloadTask(downloadTask1);
dataHub.addDownloadTask(downloadTask2);

// 数据打包完成了
dataHub.notify('http://somedomain.someaddress');
```


## 发布订阅模式
